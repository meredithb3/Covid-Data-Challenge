---
title: "COVID-19 DataFest"
author: "Meredith Brown, Matt Feder, Pouya Mohammadi"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages
```{r load-packages, message=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(usmap)
library(ggthemes)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Datasets and Descriptions
MATT PUT IN DATA INFO HERE (when corona cases stopped tracking, what is pov dataset)

For demographic data, download file called stco-mr2010-1.csv from this url: https://www2.census.gov/programs-surveys/popest/datasets/2010/modified-race-data-2010/.
The data dictionary is located at https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2000-2010/mr2010.pdf.

```{r load-data, cache = TRUE}
covidData <- read.csv("coronacounties.csv")
povertyData <- read.csv("PovertyEstimates.csv")
populationData <- usmap::countypop
populationData$fips <- as.integer(populationData$fips)
demoData1 <- read.csv("stco-mr2010-1.csv")
demoData2 <- read.csv("stco-mr2010_mt_wy.csv")
demoData <- rbind(demoData1, demoData2)
```


# Section 1: Introduction

### Exploratory Data Analysis
First, let's start by glimpsing all of our datasets.

```{r cov-data}
glimpse(covidData)

covidData %>%
  group_by(fips) %>%
  count()
```

At first glimpse, the COVID-19 dataset has 61,971 observations and 6 variables. However, after grouping by FIPS code, we see that the dataset contains data on 2,709 counties, with repeated observations representing cases on different dates.

```{r pov-data}
glimpse(povertyData)
```

The Poverty dataset has 3,193 observations (counties, states, and the US) and 34 variables.

```{r demoData-setup}
glimpse(demoData)
white_people_by_county <- demoData %>% 
        filter(IMPRACE == 1, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_white = sum(RESPOP))
  
black_people_by_county <- demoData %>% 
        filter(IMPRACE == 2, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_black = sum(RESPOP))

asian_people_by_county <- demoData %>% 
        filter(IMPRACE == 4, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_asian = sum(RESPOP))
  
hispanic_people_by_county <- demoData %>% 
        filter(ORIGIN == 2) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_hispanic = sum(RESPOP))

other_by_county <- demoData %>% 
        filter(ORIGIN == 1, !(IMPRACE %in% c(1,2,4))) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_other = sum(RESPOP))

non_white_people_by_county <- demoData %>% 
        filter(IMPRACE !=1 | ORIGIN != 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_nonwhite = sum(RESPOP))

demographicsData <- full_join(full_join( full_join(white_people_by_county,
                                black_people_by_county),
                                full_join(hispanic_people_by_county,
                                asian_people_by_county)),
                                full_join(other_by_county,
                                non_white_people_by_county))

create_fips <- function(ste, cnty){
  if (cnty < 10){
    c <- paste("00",as.character(cnty),sep="")
  }
  else if (cnty<100){
    c <- paste("0",as.character(cnty),sep="")
  }
  else{
    c <- as.character(cnty)
  }
  
  if (ste<10){
    s <- paste("0",as.character(ste),sep="")
  }
  else{
    s <- as.character(ste)
  }
  return(as.integer(paste(s,c,sep="")[1]))
}

demographicsData['fips'] <- mapply(create_fips, demographicsData$STATE, 
                                    demographicsData$COUNTY)

demoDfPopulation <- demographicsData['num_white'] + demographicsData['num_nonwhite'] 

demographicsData['perc_white'] <- demographicsData$num_white/demoDfPopulation
demographicsData['perc_black'] <- demographicsData$num_black/demoDfPopulation
demographicsData['perc_hispanic'] <- demographicsData$num_hispanic/demoDfPopulation
demographicsData['perc_nonwhite'] <- demographicsData$num_nonwhite/demoDfPopulation

glimpse(demographicsData)
```


Both the COVID-19 dataset and the Poverty dataset have a variation of the variable `fips`, which is the Federal Information Processing Standard [https://en.wikipedia.org/wiki/FIPS_county_code] that allows counties to be uniquely identified. 

Thus, the FIPS variable is a good variable by which to join these 2 datasets:

```{r join}
data <- merge(covidData, povertyData, by.x = 'fips', by.y = 'FIPStxt')
data <- merge(data, populationData, by.x = 'fips', by.y = 'fips')
data <- merge(data, demographicsData, by.x = 'fips', by.y = 'fips')
glimpse(data)
```

```{r cases-plot, warning=FALSE}
state_cases <- data %>%
  filter(date == "2020-04-15") %>%
  group_by(state) %>%
  summarise(total_deaths = sum(deaths))

cases_map <- plot_usmap(data = state_cases, values = "total_deaths", labels = TRUE, label_color = "gray", color = "red")

cases_map <- cases_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Deaths") +
              labs(title = "Deaths by State on April 15, 2020") + 
              labs(subtitle = "Most deaths are concentrated in New York State.") + 
              theme(legend.position = "right")

cases_map
```

Need to add histograms for the response variable we choose, the predictors we choose, and plots for the response v. predictors relationships
(We can do this in the section following - response variable description and predictor descriptions)

```{r cases-plot-per-capita, warning=FALSE}
state_capita_deaths <- data %>%
  filter(date == "2020-04-15") %>%
  group_by(state) %>%
  summarise(deaths_per_capita = sum(deaths)/sum(pop_2015))

capita_deaths_map <- plot_usmap(data = state_capita_deaths, values = "deaths_per_capita", labels = TRUE, label_color = "gray", color = "red")

capita_deaths_map <- capita_deaths_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Deaths Per Capita") +
              labs(title = "Deaths per Capita by State on April 15, 2020") + 
              theme(legend.position = "right")

capita_deaths_map
```


```{r deaths-plot-county, warning=FALSE}
county_deaths <- data %>%
  group_by(fips) %>%
  mutate(total_deaths = sum(deaths)) %>%
  mutate(deathsPC = total_deaths/pop_2015) %>%
  filter(date == "2020-04-15")

county_deaths %>%
  select(state, county.x, deathsPC) %>%
  arrange(desc(deathsPC)) %>%
  head(10)

county_deaths_map <- plot_usmap(regions = "counties", data = county_deaths, values = "total_deaths",
                                color = "black", size=0.01)

 
county_deaths_map <- county_deaths_map + 
              scale_fill_gradient(low = "white", high = "limegreen", name = "Deaths") +
              labs(title = "Deaths by County on April 15, 2020") + 
              theme(legend.position = "right")

county_deaths_map


county_deaths_map <- plot_usmap("counties", data = county_deaths, values = "deathsPC", color = "black", size=0.01)

county_deaths_map <- county_deaths_map + 
              scale_fill_gradient(low = "white", high = "limegreen", name = "Deaths per Capita") +
              labs(title = "Deaths per Capita by County on April 15, 2020") + 
              theme(legend.position = "right")

county_deaths_map
```

```{r poverty-plot-county, warning=FALSE}
plot_poverty_data <- merge(populationData, povertyData, by.x = 'fips', by.y = 'FIPStxt')

county_cases_map <- plot_usmap("counties", data = plot_poverty_data, values = "PCTPOVALL_2018", color = "red", size=0.01)

county_cases_map <- county_cases_map + 
              scale_fill_gradient(low = "white", high = "blue", name = "Percent in Poverty") +
              labs(title = "Poverty Level by County (2018 values)") + 
              theme(legend.position = "right")

county_cases_map
```

# everything below needs to be checked 

We should look at histograms of both cases and log(cases) to see if the apparent more even spread of log(cases) is normal compared to regular cases

```{r cases-hist}
county_deaths %>%
  ggplot(mapping = aes(x = deaths)) +
  geom_histogram() + 
  labs(title = "Histogram of Number of Cases per County", x = "Number of Cases",
       y = "# Counties with X Cases")
```

As we predicted, we see an incredible amount of right skewness in the distribution of deaths per county.

```{r logcases-hist}
county_deaths %>%
  ggplot(mapping = aes(x = log(deaths))) +
  geom_histogram() + 
  labs(title = "Histogram of Number of log of # Cases per County", x = "Number of Cases",
       y = "# Counties with log(X) Cases")
```

This historam of the log(cases) per county shows much more evidence of normailty than the graph of just cases. It would be a much better response variable, however we should analyze some other options as well.

Another possible option to analyze as a response would be the number of cases per capita of a county. This may work better as it would correlate significantly less with population as we have "accounted" for this already in the response.


We see a much more even distribution using the log of cases per capita. It is important to note that many counties appear as grey in this map; these counties have zero cases and thus the log of them returns the value of negative infinity causing this. We can remove or standardize them in our later analysis. The histogram of the log of cases per capita is very normal which would be perfect for analysis.

### Description of the Response Variable

The response variable for use in the model will be log of cases per capita. As shown above, this version of the response variable deals with some of the skewness in cases per capita. 

### Descriptions of the Regressors

THe full model will start with all of the variables included in the `data` dataset, as this is the dataset in which information about COVID-19, demographics, poverty-levels, and population statistics has been combined. Once this full model has been created, backwards selection will be used to select the variables that are most significant in predicting log cases per capita.

# Section 2: Regression Analysis 
### Generating Our Model

### Testing Our Assumptions

### Multicollinearity

### Interaction Effects

### Influential Points

### Interpreting The Coefficients


# Section 3: Conclusion

### General Commentary

### Discussion of Results

### Limitations and Ideas for Further Research 
