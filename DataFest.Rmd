---
title: "COVID-19 DataFest"
author: "Meredith Brown, Matt Feder, Pouya Mohammadi"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages
```{r load-packages, message=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(usmap)
library(ggthemes)
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Datasets and Descriptions
MATT PUT IN DATA INFO HERE (when corona cases stopped tracking, what is pov dataset)

For demographic data, download file called stco-mr2010-1.csv from this url: https://www2.census.gov/programs-surveys/popest/datasets/2010/modified-race-data-2010/.
The data dictionary is located at https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2000-2010/mr2010.pdf.

```{r load-data, cache = TRUE}
covidData <- read.csv("coronacounties.csv")
povertyData <- read.csv("PovertyEstimates.csv")
populationData <- usmap::countypop
populationData$fips <- as.integer(populationData$fips)
demoData <- read.csv("stco-mr2010-1.csv")
```


# Section 1: Introduction

### Exploratory Data Analysis
First, let's start by glimpsing all of our datasets.

```{r cov-data}
glimpse(covidData)

covidData %>%
  group_by(fips) %>%
  count()
```

At first glimpse, the COVID-19 dataset has 61,971 observations and 6 variables. However, after grouping by FIPS code, we see that the dataset contains data on 2,709 counties, with repeated observations representing cases on different dates.

```{r pov-data}
glimpse(povertyData)
```

The Poverty dataset has 3,193 observations (counties, states, and the US) and 34 variables.

```{r demoData-setup}
glimpse(demoData)
white_people_by_county <- demoData %>% 
        filter(IMPRACE == 1, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_white = sum(RESPOP))
  
black_people_by_county <- demoData %>% 
        filter(IMPRACE == 2, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_black = sum(RESPOP))

asian_people_by_county <- demoData %>% 
        filter(IMPRACE == 4, ORIGIN == 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_asian = sum(RESPOP))
  
hispanic_people_by_county <- demoData %>% 
        filter(ORIGIN == 2) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_hispanic = sum(RESPOP))

other_by_county <- demoData %>% 
        filter(ORIGIN == 1, !(IMPRACE %in% c(1,2,4))) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_other = sum(RESPOP))

non_white_people_by_county <- demoData %>% 
        filter(IMPRACE !=1 | ORIGIN != 1) %>% 
        group_by(STATE, COUNTY) %>% 
        summarise(num_nonwhite = sum(RESPOP))

demographicsData <- full_join(full_join( full_join(white_people_by_county,
                                black_people_by_county),
                                full_join(hispanic_people_by_county,
                                asian_people_by_county)),
                                full_join(other_by_county,
                                non_white_people_by_county))

create_fips <- function(ste, cnty){
  if (cnty < 10){
    c <- paste("00",as.character(cnty),sep="")
  }
  else if (cnty<100){
    c <- paste("0",as.character(cnty),sep="")
  }
  else{
    c <- as.character(cnty)
  }
  
  if (ste<10){
    s <- paste("0",as.character(ste),sep="")
  }
  else{
    s <- as.character(ste)
  }
  return(paste(s,c,sep="")[1])
}

demographicsData['fips'] <- mapply(create_fips, demographicsData['STATE'], 
                                    demographicsData['COUNTY'])

glimpse(demographicsData)
```


Both the COVID-19 dataset and the Poverty dataset have a variation of the variable `fips`, which is the Federal Information Processing Standard [https://en.wikipedia.org/wiki/FIPS_county_code] that allows counties to be uniquely identified. 

Thus, the FIPS variable is a good variable by which to join these 2 datasets:

```{r join}
data <- merge(covidData, povertyData, by.x = 'fips', by.y = 'FIPStxt')
data <- merge(data, populationData, by.x = 'fips', by.y = 'fips')
glimpse(data)
```

```{r cases-plot, warning=FALSE}
state_cases <- data %>%
  filter(date == "2020-04-15") %>%
  group_by(state) %>%
  summarise(total_deaths = sum(deaths))

cases_map <- plot_usmap(data = state_cases, values = "total_deaths", labels = TRUE, label_color = "gray", color = "red")

cases_map <- cases_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Cases") +
              labs(title = "Deaths by State on April 15, 2020") + 
              labs(subtitle = "Most deaths are concentrated in New York State.") + 
              theme(legend.position = "right")

cases_map
```

Need to add histograms for the response variable we choose, the predictors we choose, and plots for the response v. predictors relationships
(We can do this in the section following - response variable description and predictor descriptions)

```{r cases-plot-per-capita, warning=FALSE}
state_capita_deaths <- data %>%
  filter(date == "2020-04-15") %>%
  group_by(state) %>%
  summarise(deaths_per_capita = sum(cases)/sum(pop_2015))

capita_deaths_map <- plot_usmap(data = state_capita_deaths, values = "deaths_per_capita", labels = TRUE, label_color = "gray", color = "red")

capita_deaths_map <- capita_deaths_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Deaths Per Capita") +
              labs(title = "Deaths per Capita by State on April 15, 2020") + 
              labs(subtitle = "Most Concentrated in New York State.") + 
              theme(legend.position = "right")

capita_cases_map
```


```{r deaths-plot-county, warning=FALSE}
county_deaths <- data %>%
  filter(date == "2020-04-15")

county_deaths <- merge(x = populationData, y = county_deaths, by = "fips", all = TRUE)

county_deaths$log_deaths <- log(county_deaths$deaths)
county_deaths$deaths[is.na(county_deaths$deaths)] <- 0
county_deaths$log_deaths[is.na(county_deaths$log_deaths) | is.infinite(county_deaths$log_deaths)] <- 0


county_deaths_map <- plot_usmap("counties", data = county_deaths, values = "deaths", color = "red", size=0.01)

county_deaths_map <- county_deaths_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Deaths") +
              labs(title = "Deaths by County on April 15, 2020") + 
              labs(subtitle = "Most deaths are concentrated in New York State.") + 
              theme(legend.position = "right")

county_deaths_map


county_deaths_map <- plot_usmap("counties", data = county_deaths, values = "log_deaths", color = "red", size=0.01)

county_deaths_map <- county_deaths_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "Log Deaths") +
              labs(title = "Log Deaths by County on April 15, 2020") + 
              labs(subtitle = "Most deaths are concentrated in New York State.") + 
              theme(legend.position = "right")

county_deaths_map
```

```{r poverty-plot-county, warning=FALSE}
plot_poverty_data <- data <- merge(populationData, povertyData, by.x = 'fips', by.y = 'FIPStxt')

county_cases_map <- plot_usmap("counties", data = plot_poverty_data, values = "PCTPOVALL_2018", color = "red", size=0.01)

county_cases_map <- county_cases_map + 
              scale_fill_gradient(low = "white", high = "#CB454A", name = "PCTPOVALL_2018") +
              labs(title = "Poverty Level by County (2018 values)") + 
              theme(legend.position = "right")

county_cases_map
```

We should look at histograms of both cases and log(cases) to see if the apparent more even spread of log(cases) is normal compared to regular cases

```{r cases-hist}
county_cases %>%
  ggplot(mapping = aes(x = cases)) +
  geom_histogram(binwidth = 600) + 
  labs(title = "Histogram of Number of Cases per County", x = "Number of Cases",
       y = "# Counties with X Cases")
```

As we predicted, we see an incredible amount of right skewness in the distribution of cases per county.

```{r logcases-hist}
county_cases %>%
  ggplot(mapping = aes(x = log(cases))) +
  geom_histogram(binwidth = 0.5) + 
  labs(title = "Histogram of Number of log of # Cases per County", x = "Number of Cases",
       y = "# Counties with log(X) Cases")
```

This historam of the log(cases) per county shows much more evidence of normailty than the graph of just cases. It would be a much better response variable, however we should analyze some other options as well.

Another possible option to analyze as a response would be the number of cases per capita of a county. This may work better as it would correlate significantly less with population as we have "accounted" for this already in the response.

```{r percapita}
county_cases <- county_cases %>%
  mutate(casesPC = cases/pop_2015)

casesPC_map <- plot_usmap("counties", data = county_cases, values = "casesPC", color = "red", size=0.01)

casesPC_map <- casesPC_map + 
              scale_fill_gradient(low = "white", high = "limegreen", name = "Cases Per Capita") +
              labs(title = "Cases per Capita (by county)") + 
              theme(legend.position = "right")

casesPC_map

county_cases %>%
  ggplot(mapping = aes(x = casesPC)) +
  geom_histogram(binwidth = 0.0001) + 
  labs(title = "Histogram of Number of  Cases/Capita per County", x = "Number of Cases/Capita",
       y = "# Counties with X Cases per Capita")
```

Similarly to the map of cases per county, we see a large discrepancy between counties and may benefit from mapping the log of the cases per capita in order to better normalize the distribution. The histogram confirms this theory as it is majorly right skewed.

```{r logcasesPC}
county_cases$log_casesPC <- log(county_cases$casesPC)
county_cases$casesPC[is.na(county_cases$casesPC)] <- 0
county_cases$log_casesPC[is.na(county_cases$log_casesPC)] <- 0

logcasesPC_map <- plot_usmap("counties", data = county_cases, values = "log_casesPC", color = "red", size=0.01)

logcasesPC_map <- logcasesPC_map + 
              scale_fill_gradient(low = "white", high = "limegreen", name = "Log of Cases per Capita") +
              labs(title = "Log of Cases per Capita (by county)") + 
              theme(legend.position = "right")

logcasesPC_map

county_cases %>%
  ggplot(mapping = aes(x = log_casesPC)) +
  geom_histogram(binwidth = 0.3) + 
  labs(title = "Histogram of Number of log(Cases/Capita per County)", x = "Number of log(Cases/Capita)",
       y = "# Counties with log(X) Cases per Capita")
```

We see a much more even distribution using the log of cases per capita. It is important to note that many counties appear as grey in this map; these counties have zero cases and thus the log of them returns the value of negative infinity causing this. We can remove or standardize them in our later analysis. The histogram of the log of cases per capita is very normal which would be perfect for analysis.

### Description of the Response Variable

### Descriptions of the Regressors


# Section 2: Regression Analysis 
### Generating Our Model

### Testing Our Assumptions

### Multicollinearity

### Interaction Effects

### Influential Points

### Interpreting The Coefficients


# Section 3: Conclusion

### General Commentary

### Discussion of Results

### Limitations and Ideas for Further Research 



# Exploratory Data Analysis



# Regression

Ideas for regression
- Linear regression: predict from multiple factors (FIP code, poverty rate, race breakdown, etc.) their number of cases or deaths
- Logistic regression: predict if factors contribute to a death or not (don't think we have specific data on specific cases so this could be challenging)

Assumptions for regression
- Independence
- Linearity
- Normality
- Constant Variance

This website has specific graphs that would be helpful to replicate, but don't know where to get the data on an aggregate level: [https://www.apmresearchlab.org/covid/deaths-by-race#black]
